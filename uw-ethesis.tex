% uWaterloo Thesis Template for LaTeX 
% Last Updated June 14, 2017 by Stephen Carr, IST Client Services
% FOR ASSISTANCE, please send mail to rt-IST-CSmathsci@ist.uwaterloo.ca

% Effective October 2006, the University of Waterloo 
% requires electronic thesis submission. See the uWaterloo thesis regulations at
% https://uwaterloo.ca/graduate-studies/thesis.

% DON'T FORGET TO ADD YOUR OWN NAME AND TITLE in the "hyperref" package
% configuration below. THIS INFORMATION GETS EMBEDDED IN THE PDF FINAL PDF DOCUMENT.
% You can view the information if you view Properties of the PDF document.

% Many faculties/departments also require one or more printed
% copies. This template attempts to satisfy both types of output. 
% It is based on the standard "book" document class which provides all necessary 
% sectioning structures and allows multi-part theses.

% DISCLAIMER
% To the best of our knowledge, this template satisfies the current uWaterloo requirements.
% However, it is your responsibility to assure that you have met all 
% requirements of the University and your particular department.
% Many thanks for the feedback from many graduates that assisted the development of this template.

% -----------------------------------------------------------------------

% By default, output is produced that is geared toward generating a PDF 
% version optimized for viewing on an electronic display, including 
% hyperlinks within the PDF.
 
% E.g. to process a thesis called "mythesis.tex" based on this template, run:

% pdflatex mythesis	-- first pass of the pdflatex processor
% bibtex mythesis	-- generates bibliography from .bib data file(s)
% makeindex         -- should be run only if an index is used 
% pdflatex mythesis	-- fixes numbering in cross-references, bibliographic references, glossaries, index, etc.
% pdflatex mythesis	-- fixes numbering in cross-references, bibliographic references, glossaries, index, etc.

% If you use the recommended LaTeX editor, Texmaker, you would open the mythesis.tex
% file, then click the PDFLaTeX button. Then run BibTeX (under the Tools menu).
% Then click the PDFLaTeX button two more times. If you have an index as well,
% you'll need to run MakeIndex from the Tools menu as well, before running pdflatex
% the last two times.

% N.B. The "pdftex" program allows graphics in the following formats to be
% included with the "\includegraphics" command: PNG, PDF, JPEG, TIFF
% Tip 1: Generate your figures and photos in the size you want them to appear
% in your thesis, rather than scaling them with \includegraphics options.
% Tip 2: Any drawings you do should be in scalable vector graphic formats:
% SVG, PNG, WMF, EPS and then converted to PNG or PDF, so they are scalable in
% the final PDF as well.
% Tip 3: Photographs should be cropped and compressed so as not to be too large.

% To create a PDF output that is optimized for double-sided printing: 
%
% 1) comment-out the \documentclass statement in the preamble below, and
% un-comment the second \documentclass line.
%
% 2) change the value assigned below to the boolean variable
% "PrintVersion" from "false" to "true".

% --------------------- Start of Document Preamble -----------------------

% Specify the document class, default style attributes, and page dimensions
% For hyperlinked PDF, suitable for viewing on a computer, use this:
\documentclass[letterpaper,12pt,titlepage,oneside,final]{book}
 
% For PDF, suitable for double-sided printing, change the PrintVersion variable below
% to "true" and use this \documentclass line instead of the one above:
%\documentclass[letterpaper,12pt,titlepage,openright,twoside,final]{book}

% Some LaTeX commands I define for my own nomenclature.
% If you have to, it's better to change nomenclature once here than in a 
% million places throughout your thesis!
\newcommand{\package}[1]{\textbf{#1}} % package names in bold text
\newcommand{\cmmd}[1]{\textbackslash\texttt{#1}} % command name in tt font 
\newcommand{\href}[1]{#1} % does nothing, but defines the command so the
    % print-optimized version will ignore \href tags (redefined by hyperref pkg).
%\newcommand{\texorpdfstring}[2]{#1} % does nothing, but defines the command
% Anything defined here may be redefined by packages added below...

% This package allows if-then-else control structures.
\usepackage{ifthen}
\newboolean{PrintVersion}
\setboolean{PrintVersion}{false} 
% CHANGE THIS VALUE TO "true" as necessary, to improve printed results for hard copies
% by overriding some options of the hyperref package below.

%\usepackage{nomencl} % For a nomenclature (optional; available from ctan.org)
\usepackage{amsmath,amssymb,amstext} % Lots of math symbols and environments
\usepackage[pdftex]{graphicx} % For including graphics N.B. pdftex graphics driver 

% Hyperlinks make it very easy to navigate an electronic document.
% In addition, this is where you should specify the thesis title
% and author as they appear in the properties of the PDF document.
% Use the "hyperref" package 
% N.B. HYPERREF MUST BE THE LAST PACKAGE LOADED; ADD ADDITIONAL PKGS ABOVE
\usepackage[pdftex,pagebackref=false]{hyperref} % with basic options
		% N.B. pagebackref=true provides links back from the References to the body text. This can cause trouble for printing.
\hypersetup{
    plainpages=false,       % needed if Roman numbers in frontpages
    unicode=false,          % non-Latin characters in Acrobat’s bookmarks
    pdftoolbar=true,        % show Acrobat’s toolbar?
    pdfmenubar=true,        % show Acrobat’s menu?
    pdffitwindow=false,     % window fit to page when opened
    pdfstartview={FitH},    % fits the width of the page to the window
    pdftitle={uWaterloo\ LaTeX\ Thesis\ Template},    % title: CHANGE THIS TEXT!
%    pdfauthor={Author},    % author: CHANGE THIS TEXT! and uncomment this line
%    pdfsubject={Subject},  % subject: CHANGE THIS TEXT! and uncomment this line
%    pdfkeywords={keyword1} {key2} {key3}, % list of keywords, and uncomment this line if desired
    pdfnewwindow=true,      % links in new window
    colorlinks=true,        % false: boxed links; true: colored links
    linkcolor=blue,         % color of internal links
    citecolor=green,        % color of links to bibliography
    filecolor=magenta,      % color of file links
    urlcolor=cyan           % color of external links
}
\ifthenelse{\boolean{PrintVersion}}{   % for improved print quality, change some hyperref options
\hypersetup{	% override some previously defined hyperref options
%    colorlinks,%
    citecolor=black,%
    filecolor=black,%
    linkcolor=black,%
    urlcolor=black}
}{} % end of ifthenelse (no else)

\usepackage[automake,toc,abbreviations]{glossaries-extra} % Exception to the rule of hyperref being the last add-on package

\usepackage{minted}

\setminted[scala]{
	linenos,
	style=borland,
	obeytabs=true,
	tabsize=4,
	fontsize=\scriptsize,
	frame=lines,
	framesep=4mm,
	numbersep=-10pt
}
\setminted[java]{
	linenos,
	style=borland,
	obeytabs=true,
	tabsize=4,
	fontsize=\scriptsize,
	frame=lines,
	framesep=4mm,
	numbersep=-10pt
}
\setmintedinline{
	fontsize=\normalsize,
	escapeinside=\{\}
}

\newcommand{\scalainline}[1]{\mintinline{scala}|#1|}
\newcommand{\javainline}[1]{\mintinline{java}|#1|}

\def\CC{{C\nolinebreak[4]\hspace{-.05em}\raisebox{.4ex}{\tiny\bf ++}}}

\usepackage{caption}
\usepackage{subcaption}
\usepackage{epigraph}
\usepackage[section]{placeins}
\usepackage{svg}
\usepackage{smartdiagram}
\usepackage{pgfplots}

% If glossaries-extra is not in your LaTeX distribution, get it from CTAN (http://ctan.org/pkg/glossaries-extra), 
% although it's supposed to be in both the TeX Live and MikTeX distributions. There are also documentation and 
% installation instructions there.

% Setting up the page margins...
% uWaterloo thesis requirements specify a minimum of 1 inch (72pt) margin at the
% top, bottom, and outside page edges and a 1.125 in. (81pt) gutter
% margin (on binding side). While this is not an issue for electronic
% viewing, a PDF may be printed, and so we have the same page layout for
% both printed and electronic versions, we leave the gutter margin in.
% Set margins to minimum permitted by uWaterloo thesis regulations:
\setlength{\marginparwidth}{0pt} % width of margin notes
% N.B. If margin notes are used, you must adjust \textwidth, \marginparwidth
% and \marginparsep so that the space left between the margin notes and page
% edge is less than 15 mm (0.6 in.)
\setlength{\marginparsep}{0pt} % width of space between body text and margin notes
\setlength{\evensidemargin}{0.125in} % Adds 1/8 in. to binding side of all 
% even-numbered pages when the "twoside" printing option is selected
\setlength{\oddsidemargin}{0.125in} % Adds 1/8 in. to the left of all pages
% when "oneside" printing is selected, and to the left of all odd-numbered
% pages when "twoside" printing is selected
\setlength{\textwidth}{6.375in} % assuming US letter paper (8.5 in. x 11 in.) and 
% side margins as above
\raggedbottom

% The following statement specifies the amount of space between
% paragraphs. Other reasonable specifications are \bigskipamount and \smallskipamount.
\setlength{\parskip}{\medskipamount}

% The following statement controls the line spacing.  The default
% spacing corresponds to good typographic conventions and only slight
% changes (e.g., perhaps "1.2"), if any, should be made.
\renewcommand{\baselinestretch}{1} % this is the default line space setting

% By default, each chapter will start on a recto (right-hand side)
% page.  We also force each section of the front pages to start on 
% a recto page by inserting \cleardoublepage commands.
% In many cases, this will require that the verso page be
% blank and, while it should be counted, a page number should not be
% printed.  The following statements ensure a page number is not
% printed on an otherwise blank verso page.
\let\origdoublepage\cleardoublepage
\newcommand{\clearemptydoublepage}{%
  \clearpage{\pagestyle{empty}\origdoublepage}}
\let\cleardoublepage\clearemptydoublepage

% Define Glossary terms (This is properly done here, in the preamble. Could be \input{} from a file...)
% Main glossary entries -- definitions of relevant terminology

% Nomenclature glossary entries -- New definitions, or unusual terminology

% List of Abbreviations (abbreviations type is built in to the glossaries-extra package)
\newabbreviation{ast}{AST}{Abstract Syntax Tree}
\newabbreviation{tasty}{TASTy}{Typed Abstract Syntax Tree}
\newabbreviation{ir}{IR}{Intermediate Representation}
\newabbreviation{vm}{VM}{Virtual Machine}
\newabbreviation{jvm}{JVM}{Java Virtual Machine}
\newabbreviation{clr}{CLR}{Common Language Runtime}
\newabbreviation{llvm}{LLVM}{Low Level Virtual Machine}
\newabbreviation{jit}{JIT}{Just-in-time}
\newabbreviation{dsl}{DSL}{Domain Specific Language}
\newabbreviation{ssa}{SSA}{Static Single Assignment}

% List of Symbols
\newglossary*{symbols}{List of Symbols}
\newglossaryentry{phi}
{
name={$\phi$},
sort={label},
type=symbols,
description={Phi node}
}

\newglossaryentry{pi}
{
	name={$\pi$},
	sort={label},
	type=symbols,
	description={Pi node}
}

 
\makeglossaries

%======================================================================
%   L O G I C A L    D O C U M E N T -- the content of your thesis
%======================================================================
\begin{document}

% For a large document, it is a good idea to divide your thesis
% into several files, each one containing one chapter.
% To illustrate this idea, the "front pages" (i.e., title page,
% declaration, borrowers' page, abstract, acknowledgements,
% dedication, table of contents, list of tables, list of figures,
% nomenclature) are contained within the file "uw-ethesis-frontpgs.tex" which is
% included into the document by the following statement.
%----------------------------------------------------------------------
% FRONT MATERIAL
%----------------------------------------------------------------------
\input{uw-ethesis-frontpgs} 

%----------------------------------------------------------------------
% MAIN BODY
%----------------------------------------------------------------------
% Because this is a short document, and to reduce the number of files
% needed for this template, the chapters are not separate
% documents as suggested above, but you get the idea. If they were
% separate documents, they would each start with the \chapter command, i.e, 
% do not contain \documentclass or \begin{document} and \end{document} commands.
%======================================================================
\include{sections/introduction.tex}
%======================================================================
\include{sections/background.tex}
%======================================================================
\include{sections/implementation.tex}
%======================================================================
\include{sections/evaluation.tex}
%======================================================================
\include{sections/related-work.tex}
%======================================================================
\include{sections/future-work.tex}
%======================================================================
\include{sections/conclusion.tex}
%======================================================================

%----------------------------------------------------------------------
% END MATERIAL
%----------------------------------------------------------------------

% B I B L I O G R A P H Y
% -----------------------

% The following statement selects the style to use for references.  It controls the sort order of the entries in the bibliography and also the formatting for the in-text labels.
\bibliographystyle{plain}
% This specifies the location of the file containing the bibliographic information.  
% It assumes you're using BibTeX (if not, why not?).
\cleardoublepage % This is needed if the book class is used, to place the anchor in the correct page,
                 % because the bibliography will start on its own page.
                 % Use \clearpage instead if the document class uses the "oneside" argument
\phantomsection  % With hyperref package, enables hyperlinking from the table of contents to bibliography             
% The following statement causes the title "References" to be used for the bibliography section:
\renewcommand*{\bibname}{References}

% Add the References to the Table of Contents
\addcontentsline{toc}{chapter}{\textbf{References}}

\bibliography{uw-ethesis}
% Tip 5: You can create multiple .bib files to organize your references. 
% Just list them all in the \bibliogaphy command, separated by commas (no spaces).

% The following statement causes the specified references to be added to the bibliography% even if they were not 
% cited in the text. The asterisk is a wildcard that causes all entries in the bibliographic database to be included (optional).
\nocite{*}

% The \appendix statement indicates the beginning of the appendices.
\appendix
% Add a title page before the appendices and a line in the Table of Contents
\chapter*{APPENDICES}
\addcontentsline{toc}{chapter}{APPENDICES}

\chapter{Scala Unified Type System}
\includesvg[pretex=\footnotesize,width=\textwidth]{figures/svg/unified-types-diagram.svg}

\chapter{Scala 3 Compiler Phases}
\label{appendix:dotty-phases}
\begin{minted}{scala}
	/** Phases dealing with the frontend up to trees ready for TASTY pickling */
	protected def frontendPhases: List[List[Phase]] =
		List(new Parser) ::                       // scanner, parser
		List(new TyperPhase) ::                   // namer, typer
		List(new YCheckPositions) ::              // YCheck positions
		List(new sbt.ExtractDependencies) ::      // Sends information on classes' dependencies to sbt via callbacks
		List(new semanticdb.ExtractSemanticDB) :: // Extract info into .semanticdb files
		List(new PostTyper) ::                    // Additional checks and cleanups after type checking
		List(new sjs.PrepJSInterop) ::            // Additional checks and transformations for Scala.js (Scala.js only)
		List(new Staging) ::                      // Check PCP, heal quoted types and expand macros
		List(new sbt.ExtractAPI) ::               // Sends a representation of the API of classes to sbt via callbacks
		List(new SetRootTree) ::                  // Set the `rootTreeOrProvider` on class symbols
		Nil
\end{minted}

\begin{minted}{scala}
	/** Phases dealing with TASTY tree pickling and unpickling */
	protected def picklerPhases: List[List[Phase]] =
		List(new Pickler) ::            // Generate TASTY info
		List(new PickleQuotes) ::       // Turn quoted trees into explicit run-time data structures
		Nil
\end{minted}

\begin{minted}{scala}
	/** Phases dealing with the transformation from pickled trees to backend trees */
	protected def transformPhases: List[List[Phase]] =
		List(
			new FirstTransform,         // Some transformations to put trees into a canonical form
			new CheckReentrant,         // Internal use only: Check that compiled program has no data races involving global vars
			new ElimPackagePrefixes,    // Eliminate references to package prefixes in Select nodes
			new CookComments,           // Cook the comments: expand variables, doc, etc.
			new CheckStatic,            // Check restrictions that apply to @static members
			new BetaReduce,             // Reduce closure applications
			new init.Checker) ::        // Check initialization of objects
		List(
			new ElimRepeated,           // Rewrite vararg parameters and arguments
			new ExpandSAMs,             // Expand single abstract method closures to anonymous classes
			new ProtectedAccessors,     // Add accessors for protected members
			new ExtensionMethods,       // Expand methods of value classes with extension methods
			new UncacheGivenAliases,    // Avoid caching RHS of simple parameterless given aliases
			new ByNameClosures,         // Expand arguments to by-name parameters to closures
			new HoistSuperArgs,         // Hoist complex arguments of supercalls to enclosing scope
			new SpecializeApplyMethods, // Adds specialized methods to FunctionN
			new RefChecks) ::           // Various checks mostly related to abstract members and overriding
		List(
		 	// Turn opaque into normal aliases
			new ElimOpaque,            
			// Compile cases in try/catch
			new TryCatchPatterns,      
			// Compile pattern matches
			new PatternMatcher,         
			// Make all JS classes explicit (Scala.js only)
			new sjs.ExplicitJSClasses,  
			// Add accessors to outer classes from nested ones.
			new ExplicitOuter,          
			// Make references to non-trivial self types explicit as casts
			new ExplicitSelf,           
			// Expand by-name parameter references
			new ElimByName,             
			// Optimizes raw and s string interpolators by rewriting them to string concatentations
			new StringInterpolatorOpt) :: 
		List(
			new PruneErasedDefs,        // Drop erased definitions from scopes and simplify erased expressions
			new InlinePatterns,         // Remove placeholders of inlined patterns
			new VCInlineMethods,        // Inlines calls to value class methods
			new SeqLiterals,            // Express vararg arguments as arrays
			new InterceptedMethods,     // Special handling of `==`, `|=`, `getClass` methods
			new Getters,                // Replace non-private vals and vars with getter defs (fields are added later)
			new SpecializeFunctions,    // Specialized Function{0,1,2} by replacing super with specialized super
			new LiftTry,                // Put try expressions that might execute on non-empty stacks into their own methods
			new CollectNullableFields,  // Collect fields that can be nulled out after use in lazy initialization
			new ElimOuterSelect,        // Expand outer selections
			new ResolveSuper,           // Implement super accessors
			new FunctionXXLForwarders,  // Add forwarders for FunctionXXL apply method
			new ParamForwarding,        // Add forwarders for aliases of superclass parameters
			new TupleOptimizations,     // Optimize generic operations on tuples
			new LetOverApply,           // Lift blocks from receivers of applications
			new ArrayConstructors) ::   // Intercept creation of (non-generic) arrays and intrinsify.
		List(new Erasure) ::            // Rewrite types to JVM model, erasing all type parameters, abstract types and refinements.
		List(
			new ElimErasedValueType,    // Expand erased value types to their underlying implmementation types
			new PureStats,              // Remove pure stats from blocks
			new VCElideAllocations,     // Peep-hole optimization to eliminate unnecessary value class allocations
			new ArrayApply,             // Optimize `scala.Array.apply([....])` and `scala.Array.apply(..., [....])` into `[...]`
			new sjs.AddLocalJSFakeNews, // Adds fake new invocations to local JS classes in calls to `createLocalJSClass`
			new ElimPolyFunction,       // Rewrite PolyFunction subclasses to FunctionN subclasses
			new TailRec,                // Rewrite tail recursion to loops
			new CompleteJavaEnums,      // Fill in constructors for Java enums
			new Mixin,                  // Expand trait fields and trait initializers
			// Expand lazy vals
			new LazyVals,              
			// Add private fields to getters and setters
			new Memoize,                
			 // Expand non-local returns
			new NonLocalReturns,       
			// Represent vars captured by closures as heap objects
			new CapturedVars) ::        
		List(
			new Constructors,           // Collect initialization code in primary constructors
			// Note: constructors changes decls in transformTemplate, no InfoTransformers should be added after it
			new Instrumentation) ::     // Count calls and allocations under -Yinstrument
		List(
			// Lifts out nested functions to class scope, storing free variables in environments
			new LambdaLift,             
			// Note: in this mini-phase block scopes are incorrect. No phases that rely on scopes should be here
			// Replace `this` references to static objects by global identifiers
			new ElimStaticThis,         
			// Identify outer accessors that can be dropped
			new CountOuterAccesses) :: 
		List(
			// Drop unused outer accessors
			new DropOuterAccessors,     
			// Lift all inner classes to package scope
			new Flatten,                
			// Renames lifted classes to local numbering scheme
			new RenameLifted,           
			// Replace wildcards with default values
			new TransformWildcards,     
			 // Move static methods from companion to the class itself
			new MoveStatics,           
			// Widen private definitions accessed from nested classes
			new ExpandPrivate,          
			 // Repair scopes rendered invalid by moving definitions in prior phases of the group
			new RestoreScopes,         
			// get rid of selects that would be compiled into GetStatic
			new SelectStatic,           
			// Generate JUnit-specific bootstrapper classes for Scala.js (not enabled by default)
			new sjs.JUnitBootstrappers, 
			// Find classes that are called with super
			new CollectSuperCalls) ::   
		Nil
\end{minted}

\begin{minted}{scala}
	/** Generate the output of the compilation */
	protected def backendPhases: List[List[Phase]] =
		List(new backend.sjs.GenSJSIR) :: // Generate .sjsir files for Scala.js (not enabled by default)
		List(new GenBCode) ::             // Generate JVM bytecode
		Nil
\end{minted}
%======================================================================

\end{document}
